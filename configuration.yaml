# Configure a default setup of Home Assistant (frontend, api, etc)
# Als de default_config gedeactiveerd wordt, dan verschijnt kaart (map) niet standaard in het menu
# default_config:

# useful links
# https://www.uuidgenerator.net/
# https://emojidb.org/
# https://pictogrammers.github.io/@mdi/font/6.6.96/
# https://materialdesignicons.com/
# https://mdi.bessarabov.com/
# https://www.zapsplat.com/sound-effect-category/sirens-and-alarms/
# https://app.diagrams.net/
# https://demo.home-assistant.io/#/energy
# https://www.tablesgenerator.com/markdown_tables#


# integration (Riemann sum integral) unit moet k, M, G of T zijn. (NIET kW of kWh) 
# Attention: the “platform: integration” does not support the state_class: measurement
# Therefore it does not show up in the energy dashboard.

# An integration sensor is useful in energy billing scenarios since energy is generally billed in kWh and many sensors provide power in W (Watts).
# If you have a sensor that provides you with power readings in Watts (uses W as unit_of_measurement), 
# then you can use the integration sensor to track how much energy is being spent.

#   Examples
#   value_template: '{{ (value| float)}}'
#   value_template: '{{ (value.rstrip(" °C") | float) }}'
#   value_template: '{{ (value.rstrip(" %") | float) }}'


# OLD method
# sensor:
#   - platform: template
#     sensors:
#       energy_return:
#
# NEW method
# template:
#   - sensor:
#       - name: "energy_return"



backup:
bluetooth:
conversation:           # to speak to Home Assistant
counter:
daikin_residential:
  email: bartland@gmail.com
  password: Qc#DHeq9!7!WEe*

device_tracker:
  - platform: tomato
    host: 192.168.86.1
    username: root
    password: admin
    http_id: TID3fac41d84c91e1a8
dhcp:
discovery:
energy:
frontend:
  themes: !include_dir_merge_named themes
  extra_module_url:
    - /hacsfiles/hass-hue-icons/hass-hue-icons.js
    - /hacsfiles/lovelace-card-mod/card-mod.js
hardware:
history:
homeassistant_alerts:
#image:
input_boolean:
input_button:
input_datetime:
input_number:
input_text:
  trigger_source:
    name: Trigger Source  #String om bij te houden welke sensor het alarm triggert
light:
logbook:
logger:
  default: error
# map:  # Enables in the left menu a map showing the location of tracked devices
media_source:
mobile_app:
my:
person:
scene: !include scenes.yaml
schedule:
script: !include_dir_merge_named scripts
stream:
sun:
system_health:
tag:
timer:
  car_climatisation:
    icon: mdi:radiator
usb:
zeroconf:
zone:

# lovelace:
#   mode: yaml
#   resources:
#     - url: /hacsfiles/battery-state-card/battery-state-card.js
#       type: module

# python_script is not the same as pyscript. It is less advanced.
# python_script:
# pyscript is more advanced than python_script. pyscript can do imports of libraries
# pyscript:
#   allow_all_imports: true
#   hass_is_global: true


##### Text to speech ##########################################
tts:
  - platform: google_translate
    cache: false
    cache_dir: /tmp/tts
    time_memory: 57600    #min 60 max 57600 (16 hours)
    base_url: http://192.168.86.101:8123
    service_name: google_say
    language: 'nl'
  - platform: edge_tts
    language: nl-BE-DenaNeural    #nl-BE-ArnaudNeural

##### YAML file locations #####################################    
group: !include groups.yaml
automation: !include automations.yaml

google_assistant: !include google_assistant_integration.yaml
shell_command: !include shell_commands.yaml



#####################################################
homeassistant:
  name: Eikenbos
  country: BE
  currency: EUR
  external_url: https://ha.bartland.duckdns.org
  internal_url: http://192.168.86.100:8123
  time_zone: "Europe/Brussels"

  allowlist_external_dirs:
    - "/config"

  ### The following installs all package files, including lights, alarm, humidity etc.
  packages: !include_dir_named packages
  
  customize:
    zone.home:
      radius: 500

  # changes required for the engery dashboard (info from 16/10/2022)
  # You don’t need a last reset for the total_increasing state_class
    sensor.ontvochtiger_energieverbruik:
      device_class: energy
      state_class: total_increasing

    sensor.wasmachine_energieverbruik:
      device_class: energy
      state_class: total_increasing

    sensor.living_tv_energieverbruik:
      device_class: energy
      state_class: total_increasing

    sensor.amilya_tv_energieverbruik:
      device_class: energy
      state_class: total_increasing

    sensor.alunya_tv_energieverbruik:
      device_class: energy
      state_class: total_increasing

    sensor.master_bedroom_tv_energieverbruik:
      device_class: energy
      state_class: total_increasing



  # secrets should not be mentioned in this file; it is automatic !
  # secrets: !include secrets.yaml

  # manuele aanpassing van alle sensoren eindigend op "energieverbruik" om in het energy dashboard te krijgen
  customize_glob:
    # sensor.*energieverbruik:
    #   unit_of_measurement: "kWh"
    #   device_class: energy
    #   state_class: total_increasing
    #   last_reset: "1970-01-01T00:00:00+00:00"

    sensor.*energy:
      unit_of_measurement: "kWh"     
      device_class: energy
      state_class: total_increasing  # measurement werkt niet in energy dashboard
      last_reset: "1970-01-01T00:00:00+00:00"

    sensor.*productie:
      unit_of_measurement: "kWh"     
      device_class: energy
      state_class: total_increasing
      last_reset: "1970-01-01T00:00:00+00:00"  

    # the sensor.zonne_energie_totaal created by the "integration" integration 
    # does not have the necessary attributes to be used in the energy dashboard.
    # Therefore, this customization adds the necessary attributes.
    sensor.zonne_energie_totaal:
      # source: sensor.solar_power
      unit_of_measurement: kWh
      device_class: energy
      state_class: total_increasing # of moet het "measurement" of "total" zijn ?
      last_reset: "1970-01-01T00:00:00+00:00"
      icon: mdi:chart-histogram
      

#####################################################
# needed when using reverse proxy managers (eg. Nginx)
http:
  # TO DO : ik ken het pad niet
  # ssl_certificate: /opt/letsencrypt/live/npm-1/fullchain.pem
  # ssl_key: /opt/letsencrypt/live/npm-1/privkey.pem
  use_x_forwarded_for: true
  trusted_proxies:
    - 192.168.86.0/24   # the IP address of the proxy server
    - 192.168.155.0/24  # the IP range of the Droidland hotspot  
    - 172.18.0.8        # dit is het ip-adres van nginx in docker
    - 172.18.0.0/24
    - 172.18.0.2        # the IP address of the Wireguard server
    - 172.18.0.3        # ???
    - 10.13.13.2        # WireGuard client Bart gsm
    - 10.13.13.3        # WireGuard client Madouce gsm
    - 10.13.13.4        # WireGuard client Chromebook Bart

    
  ip_ban_enabled: false         # use this to enable auto IP ban
  login_attempts_threshold: 3   # set the number of allowed login attempts

recorder:
  purge_keep_days: 7
  commit_interval: 30
  exclude:
    entities:
      - sensor.date
      - sensor.time
      - sensor.last_boot
      - sun.sun
      - sensor.disk_use_percent
      - binary_sensor.alunya_a71_apparaat_vergrendeld
      - binary_sensor.alunya_a71_interactief
      - binary_sensor.sm_g975f_interactive
      - sensor.google_wifi_system_aaaaabzipgy_upload_traffic
      - sensor.google_wifi_system_aaaaabzipgy_download_traffic
      - sensor.network_in_eth0
      # - sensor.net_neutrality_home
      # - sensor.net_neutrality_car
      # - sensor.net_neutrality
    domains:
      - automation
      - camera
      - group
      - updater
      - persistent_notification
      - scene
      - script
      - sun
      - weather
      - zone
      - zwave
      - device_tracker  # nearly every device has a location tracker
      # do not exclude mediaplayer, otherwise the daily statistics will not work

influxdb:
  api_version: 2
  ssl: false
  host: localhost
  port: 8086
  token: caGcix5eP8n53E1msFJcpBFm6M6gxwXTG2gHAkRfQCEAMdho5E5XrCLVJym3Ndl5nGnU1-DFphLkR3Nh0LIiiw==
  organization: 6fe6192d84027fb4
  bucket: HomeAssistant
  default_measurement: state
  tags:
    source: HA
  tags_attributes:
    - friendly_name

#fan:    
#  - platform: xiaomi_miio_airpurifier
#    name: Xiaomi Air Purifier 3H
#    host: 192.168.86.247
#    token: !secret purifier_3H_token
#    model: zhimi.airpurifier.mb3

netatmo:
# create client_id and client_secret at https://dev.netatmo.com/apps

# Eikenbos (bart@van-landschoot.be)
  client_id: 639ccb520c005b86eb0280a2
  client_secret: SHtT5LrjtoCwT3IcrSiSCsDySu9eyva2zkJt2uivk5ko

# Waarschoot (bartland@gmail.com)
#  client_id: 60d72f7458da3d00f57f4fd5 
#  client_secret: cEP5HXSCw74AEey7KkpEFIBwrzO

alarm_control_panel:
  - platform: manual
    name: home alarm
    code: !secret alarm_code
    code_arm_required: false
    arming_time: 60 # numer of seconds in arming status before alarm is put on armed status
    delay_time: 30 # number of seconds in pending status before the alarm triggers
    trigger_time: 4 # number of seconds in triggered status before the alarm is fired
    disarmed:
      trigger_time: 0
    armed_home:
      arming_time: 0
      delay_time: 0





sensor:
  - platform: template
    sensors:
      temp_forecast_4_hours:
        friendly_name: "Forecast 4 hours"
        value_template: "{{ state_attr('weather.eikenbos_openweather', 'forecast')[:4] | map(attribute='temperature') | average | round(1) }}"
        unit_of_measurement: °C
        device_class: temperature

      net_power:
        friendly_name: "net power"
        unique_id: 'ffc1bd97-4dbf-483c-8659-48ed4c2790ad'
        unit_of_measurement: W
        device_class: power
        # total of the power measured on the 3 phases via Shelly 3EM
        value_template: >
          {% set a = states('sensor.shellyem3_bcff4dfd1dbb_channel_a_power') | float(default=0) %}
          {% set b = states('sensor.shellyem3_bcff4dfd1dbb_channel_b_power') | float(default=0) %}
          {% set c = states('sensor.shellyem3_bcff4dfd1dbb_channel_c_power') | float(default=0) %}
          {{ ( a + b + c ) | round(default=0) }}

  - platform: powercalc
    name: unload_battery
    daily_fixed_energy:
      value: 0.00

  - platform: buienalarm
    timeframe: 15
    name: buienalarm
    monitored_conditions:
      - temperature
      - precipitation
      - precipitation_forecast_average
      - precipitation_forecast_total
      - next_rain_forecast

  - platform: time_date
    display_options:
      - 'time'
      - 'date'
      - "date_time"
      

  - platform: min_max
    type: mean
    name: avg_outside_temp
    entity_ids:
      - sensor.buienalarm_temperature
      - sensor.buienradar_temperature
    round_digits: 2
    
  - platform: min_max
    type: mean
    name: avg_inside_humidity
    entity_ids:
      - sensor.living_humidity
      - sensor.kamer_amilya_humidity
      - sensor.veranda_humidity
      - sensor.gang_humidity
      - sensor.badkamer_humidity
      - sensor.kamer_alunya_humidity
      - sensor.master_bedroom_humidity
    round_digits: 0
    
  - platform: min_max
    type: mean
    name: avg_inside_temperature
    entity_ids:
      - sensor.living_temperature
      - sensor.kamer_amilya_temperature
      - sensor.veranda_temperature
      - sensor.gang_temperature
      - sensor.badkamer_temperature
      - sensor.kamer_alunya_temperature
      - sensor.master_bedroom_temperature
    round_digits: 1

  - platform: history_stats
    name: "Bart thuis vandaag"
    entity_id: person.bart
    state: 'home'
    type: time
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

  - platform: history_stats
    name: "Madouce thuis vandaag"
    entity_id: person.madouce
    state: 'home'
    type: time
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

  - platform: history_stats
    name: "Amilya thuis vandaag"
    entity_id: person.amilya
    state: 'home'
    type: time
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

  - platform: history_stats
    name: "Alunya thuis vandaag"
    entity_id: person.alunya
    state: 'home'
    type: time
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

  - platform: template
    sensors:
      day_max_temp_datetime:
        friendly_name: "max dagtemperatuur uur"
        unit_of_measurement: "h"
        value_template: >
          {% set start = now().replace(hour=0,minute=0,second=0, microsecond=0) %}
          {% set end = (start + timedelta(days=1)) %}
          {% set start = start.strftime("%Y-%m-%dT%H:%M:%S+00:00") %}
          {% set end = end.strftime("%Y-%m-%dT%H:%M:%S+00:00") %}
          {% set ns = namespace(min_temp=100, max_temp=-100) %}
          {% for i in state_attr('weather.eikenbos_openweather', 'forecast') -%}
            {% if start <= i.datetime < end %}
              {% if i.temperature < ns.min_temp %}
                {% set ns.min_temp = i.temperature %}
                {% set ns.min_temp_datetime = i.datetime %}
              {% endif %}
              {% if i.temperature > ns.max_temp %}
                {% set ns.max_temp = i.temperature %}
                {% set ns.max_temp_datetime = i.datetime %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {{ as_timestamp(ns.max_temp_datetime)|timestamp_custom('%H:%M') }}


###################################################################################
# Integration
# The Riemann sum integration calculates energy (in kWh) from a power sensor (in W)
# integration (Riemann sum integral) unit moet k, M, G of T zijn. (NIET kW of kWh) 
###################################################################################

#  - platform: integration
#    source: sensor.all_lights_power
#    name: Totaal energieverbruik lichten
#    unit_prefix: k
#    unit: kWh
#    round: 2

  - platform: integration
    source: sensor.power_production_now
    name: gerealiseerde zonneproductie
    unit_prefix: k
    unit_time: h

  - platform: integration
    # creates a sensor called: sensor.huis_energieverbruik in kWh
    source: sensor.huisverbruik
    name: huis energieverbruik
    unit_prefix: k
    round: 2
    method: left

  - platform: integration
    # creates a sensor called sensor.zonne_energie_totaal in kWh
    source: sensor.solar_power
    name: zonne energie totaal
    unit_prefix: k
    round: 2
    method: left

  - platform: filter
    name: net power avg
    entity_id: sensor.net_power
    filters:
      - filter: outlier
        window_size: 6   # number of samples taken
        radius: 4.0
      # - filter: time_simple_moving_average
      #   window_size: "00:05"
      # - filter: throttle
      #   window_size: 120

###############################################################################
# template / sensor
###############################################################################

template:
  - sensor:

      # this is the new way to define sensors via templates
      # this works !
      - name: net_consumption_energy_total
        unit_of_measurement: kWh
        device_class: energy    
        state_class: total    # or "measurement"
        # total of the energy calculated by Shelly 3EM
        state: >
          {% set phase1 = states('sensor.shellyem3_bcff4dfd1dbb_channel_a_energy') | float(default=0) %}
          {% set phase2 = states('sensor.shellyem3_bcff4dfd1dbb_channel_b_energy') | float(default=0) %}
          {% set phase3 = states('sensor.shellyem3_bcff4dfd1dbb_channel_c_energy') | float(default=0) %}
          {{ float(phase1) + float(phase2) + float(phase3) }}
        availability: >
          {{ not ( is_state('sensor.shellyem3_bcff4dfd1dbb_channel_a_energy', 'unavailable') or
          is_state('sensor.shellyem3_bcff4dfd1dbb_channel_b_energy', 'unavailable') or
          is_state('sensor.shellyem3_bcff4dfd1dbb_channel_c_energy', 'unavailable') ) }}
        attributes:         
          last_reset: '1970-01-01T00:00:00+00:00'

      # this is the new way to define sensors via templates
      # this works !
      - name: net_injection_energy_total
        unit_of_measurement: kWh
        device_class: energy
        state_class: total    # or "measurement"
        state: >
          {% set phase1 = states('sensor.shellyem3_bcff4dfd1dbb_channel_a_energy_returned') | float(default=0) %}
          {% set phase2 = states('sensor.shellyem3_bcff4dfd1dbb_channel_b_energy_returned') | float(default=0) %}
          {% set phase3 = states('sensor.shellyem3_bcff4dfd1dbb_channel_c_energy_returned') | float(default=0) %}
          {{ float(phase1) + float(phase2) + float(phase3) }}
        availability: >
          {{ not ( is_state('sensor.shellyem3_bcff4dfd1dbb_channel_a_energy_returned', 'unavailable') or
          is_state('sensor.shellyem3_bcff4dfd1dbb_channel_b_energy_returned', 'unavailable') or
          is_state('sensor.shellyem3_bcff4dfd1dbb_channel_c_energy_returned', 'unavailable') ) }}  
        attributes:         
          last_reset: '1970-01-01T00:00:00+00:00'

      - name: "car charge start time"
        state: >
          {% set target = states('input_number.car_charge_target_percentage') | float(default=0) %}
          {% set soc = states('sensor.audi_e_tron_sportback_state_of_charge') | float(default=0) %}
          {% set nog_te_laden_procent = [target - soc, 0] | max %}
          {% set nog_te_laden_minuten = nog_te_laden_procent * states('input_number.minuten_voor_1_laden') | round(2) %}
          {{ strptime((as_timestamp(states('input_datetime.car_charge_target_time')) - ((nog_te_laden_minuten | float(default=0) + 10 ) * 60) ) | timestamp_custom('%Y-%m-%d %H:%M',false), '%Y-%m-%d %H:%M') }}

      - name: "verwachte zonneproductie morgen"
        unit_of_measurement: kWh
        state: >
          {{ (states('sensor.energy_production_tomorrow') | float + states('sensor.energy_production_tomorrow_2') | float ) | round() }}

      - name: "huisverbruik"
        unique_id: '3b201f08-68f2-4b19-8f98-3fa1fd580316'
        state: >
            {{ states('sensor.solar_power') | float(default=0) + (states('sensor.net_power') | float(default=0) ) | round(0) }}
        unit_of_measurement: W
        device_class: power
        state_class: measurement   # total_increasing

################################################################################
# binary sensors
################################################################################

binary_sensor:
  - platform: ping
    name: google_server
    host: 8.8.8.8
    scan_interval: 5    # scan every 5 minutes



rest_command:
# webhook om meterstanden op de site energieid te posten
  energie_id_set_electricity_usage:
    url: !secret energie_id_usage_webhook
    method: 'post'
    content_type: 'application/json'
    payload: '{"remoteId": "ha-webhook-electricity", "remoteName": "Elektriciteit (Home Assistant)", "metric": "electricityImport", "unit": "kWh", "readingType": "counter", "data": [["{{ now().isoformat() }}", {{ usage }}]]}'

# Deze code hieronder in automatisaties gebruiken    
# service: rest_command.energie_id_set_electricity_usage
#  data:
#    usage: "{{ states('input_number.electricity_usage') | int }}"  


################################################
# Send car info to A Better Route Planner
# info: https://juju.nz/michaelh/post/2021/abrp/
################################################
  update_abrp:
    method: POST
    headers:
      content_type: "charset=utf-8; application/x-www-form-urlencoded"
    url: >
      http://api.iternio.com/1/tlm/send?token=444e9623-255e-44b7-b2cd-bf9dade6f46b&api_key=846001dd-c532-4e61-a9f4-11cd1123fb6b&tlm={"utc":{{ as_timestamp(utcnow()) | float(default=0) }},"soc":{{ states('sensor.audi_e_tron_sportback_state_of_charge') }},"soh":99,"is_charging":"no","car_model":"audi:etron:21:86:other"}

        
# Add Portainer to Home Assistant navigation menu
panel_iframe:
  portainer:
    title: "Portainer"
    url: "http://192.168.86.101:9000/"
    icon: mdi:docker
    require_admin: true

  automation_list:
    title: "Automations"
    url: "http://192.168.86.100:8123/config/automation/dashboard"
    icon: mdi:list-box-outline
    require_admin: true

  duplicati:
    title: "Duplicati"
    url: "http://192.168.86.101:8200/"
    icon: mdi:backup-restore
    require_admin: true

  influxdb:
    title: "InfluxDB"
    url: "http://192.168.86.101:8086/orgs/6fe6192d84027fb4/dashboards/096bf9184c088000?lower=now%28%29%20-%202d"
    icon: mdi:backup-restore
    require_admin: true
  
panel_custom:
  - name: automations-tree
    # url_path needs to be unique for each panel_custom config
    url_path: automations-tree
    sidebar_title: Automations
    sidebar_icon: mdi:robot
    module_url: /local/tree-panel/automations-tree.js  

battery_sim:
  auto_batterij:
    name: auto batterij
    import_sensor: sensor.charger_real_power
    export_sensor: sensor.unload_battery
    max_discharge_rate_kw: 11.0
    size_kwh: 90.0
    # energy_tariff: 0.30

  thuisbatterij:
    name: thuisbatterij
    import_sensor: sensor.solar_power
    export_sensor: sensor.unload_battery
    max_discharge_rate_kw: 11.0
    size_kwh: 10.0
    # energy_tariff: 0.00

#media_player:
#  - platform: samsungtv_custom
#    host: 192.168.86.57
#    port: 8001
#    sourcelist: '{"PlayStation": "KEY_HDMI1", "RaspberryPi": "KEY_HDMI2", "Chromecast": "KEY_HDMI3"}'


# camera:
#   - platform: generic
#     name: "LSC indoor camera (1920 x 1080)"
#     still_image_url: http://192.168.86.101:8123/local/images/lsc_indoor_camera.jpg
#     stream_source: rtsp://admin:admin@192.168.86.21:8554/Streaming/Channels/101

camera:
  - platform: ffmpeg
    input: rtsp://192.168.86.21/ch0_1.h264
    name: LSC indoor camera

