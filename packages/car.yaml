############################ Table of Contents ############################ 
# 
#   Automations
#
#     batterij laag en niet verbonden (week)
#     batterij laag en niet verbonden (weekend)
#     autolader is verbonden
#     auto laadt = melding
#     auto gedaan met laden = melding
#     Auto 's avonds op slot?
#     auto sluiten
#     auto op slot = melding wissen
#     Auto 10 min. niet op slot = melding
#


# bluetooth address Etron: 98:49:14:C1:37:0B
# VIN etron: WAUZZZGE6MB019131

############################ Automations ################################## 
automation:


#########################
# Auto op slot
#########################

- alias: ðŸš— Auto 's avonds op slot?
  id: 'b35dc129-9a89-4655-b8da-32e7798880c1'
  description: Stuur een bericht als auto om 21u30 nog open is.
  trigger:
  - platform: time
    at: '21:30:00'
  condition:
  - condition: state
    entity_id: lock.audi_e_tron_sportback_door_lock
    state: unlocked
  - condition: state
    entity_id: device_tracker.bart_s10
    state: 0
    attribute: speed
    for:
      hours: 0
      minutes: 2
      seconds: 0
      milliseconds: 0
  - condition: state
    entity_id: device_tracker.madouce_s20
    state: 0
    attribute: speed
    for:
      hours: 0
      minutes: 2
      seconds: 0
      milliseconds: 0  
  action:
  - service: notify.bart_phone
    data:
      title: Auto niet op slot!
      message: ðŸš™ Er wordt nu geprobeerd om de auto te sluiten.
      data:
        channel: Important
        tag: auto_sluiten
        color: red
        actions:
        - action: URI
          title: meer info
          uri: /eikenbos-dashboard/e-tron        
  - service: notify.madouce_phone
    data:
      title: Auto niet op slot!
      message: ðŸš™ Er wordt nu geprobeerd om de auto te sluiten.
      data:
        channel: Important
        tag: auto_sluiten
        color: red
        actions:
        - action: URI
          title: meer info
          uri: /eikenbos-dashboard/e-tron        
  - service: lock.lock
    target:
      entity_id: lock.audi_e_tron_sportback_door_lock
  mode: single

- alias: auto sluiten
  id: 'ead368ce-23d8-4cd2-b63b-ad6cc916bae0'
  trigger:
  - platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: lock_car
  action:
  - service: lock.lock
    target:
      entity_id: lock.audi_e_tron_sportback_door_lock
  mode: single

- alias: ðŸš— auto is op slot (clear_notification)
  id: 'aef6ff87-883d-40ed-b638-a59c6eb66837'
  description: ''
  trigger:
  - platform: state
    entity_id: lock.audi_e_tron_sportback_door_lock
    to: 'locked'
  condition: []
  action:
  - service: notify.bart_phone
    data:
      message: "clear_notification"
      data:
        tag: auto_sluiten
  - service: notify.madouce_phone
    data:
      message: "clear_notification"
      data:
        tag: auto_sluiten        
  mode: single

- alias: ðŸš— Auto 2 min. niet op slot = refresh & melding
  id: 'a2af962e-7fcf-4e6e-822e-5b33bc450628'
  description: ''
  trigger:
  - platform: state
    entity_id: lock.audi_e_tron_sportback_door_lock
    to: 'unlocked'
    for:
      hours: 0
      minutes: 2
      seconds: 0
  condition:
  - condition: state
    entity_id: device_tracker.bart_s10
    state: 0
    attribute: speed
    for:
      hours: 0
      minutes: 2
      seconds: 0
      milliseconds: 0
  - condition: state
    entity_id: device_tracker.madouce_s20
    state: 0
    attribute: speed
    for:
      hours: 0
      minutes: 2
      seconds: 0
      milliseconds: 0
  action:
  - service: audiconnect.refresh_data
    data:
      vin: WAUZZZGE6MB019131
  - delay:
      minutes: 2      
  - service: notify.bart_phone
    data:
      message: ðŸš™ Auto niet op slot! (veeg omlaag voor acties)
      data:
        channel: Important
        tag: auto_sluiten
        color: red
        actions:
        - action: lock_car
          title: sluit auto
        - action: URI
          title: meer info
          uri: /eikenbos-dashboard/e-tron          
  - service: notify.madouce_phone
    data:
      message: ðŸš™ Auto niet op slot! (veeg omlaag voor acties)
      data:
        channel: Important
        tag: auto_sluiten
        color: red
        actions:
        - action: lock_car
          title: sluit auto          
        - action: URI
          title: meer info
          uri: /eikenbos-dashboard/e-tron
  mode: single

  
#########################
# Auto climatisatie
#########################  

- alias: ðŸš— start auto climatisatie op uur bepaald in GUI
  id: '583aabff-84db-4aac-a7de-023aee0d79f1'
  trigger:
  - platform: template
    value_template: "{{ states('sensor.time') == (states.input_datetime.car_climatisation_time.attributes.timestamp
      | int | timestamp_custom('%H:%M', False)) }}"
  condition:
  - condition: state
    entity_id: input_boolean.car_climatisation_timer
    state: 'on'
  action:
   - service: script.auto_start_climatisatie_nu
  mode: restart

- alias: ðŸš— Om 19u in Waarschoot en koud = vraag auto voorverwarmen
  id: '8fa06ed3-7c9f-453d-80d4-a246df6633f8'
  description: ''
  trigger:
  - platform: time
    at: '19:00'
  condition:
  - condition: numeric_state
    entity_id: sensor.audi_e_tron_sportback_outdoor_temperature
    below: 15
  - condition: state
    entity_id: person.bart
    state: Waarschoot
  - condition: state
    entity_id: device_tracker.bart_s10
    state: 0
    attribute: speed
    for:
      hours: 0
      minutes: 2
      seconds: 0
      milliseconds: 0
  action:
  - service: notify.bart_phone
    data:
      message: ðŸš™ Moet de auto worden voorverwamd?
      data:
        tag: auto_verwarmen
        color: green
        actions:
        - action: URI
          title: zo ja, klik hier
          uri: /eikenbos-dashboard/e-tron-heater
  mode: single

- alias: ðŸš— Bart verlaat auto
  id: '63ee4ac0-2944-4531-bc17-a2a6d60ff341'
  description: ''
  trigger:
    - platform: state
      entity_id: binary_sensor.bart_phone_connected_to_car
      from: 'on'
      to: 'off'
      for: "00:00:05"
  condition:
    - condition: numeric_state
      entity_id: sensor.audi_e_tron_sportback_outdoor_temperature
      below: 15
  action:
  - choose:
    # indien aankomst thuis, niets doen
    - conditions:
      - condition: state
        entity_id: person.bart
        state: "home"
      sequence:
    # indien aankomst bij sauna, onmiddellijk vragen
    - conditions:
        - condition: or
          conditions:
            - condition: state
              entity_id: person.bart
              state: "Sauna Elzenhof"
            - condition: state
              entity_id: person.bart
              state: "Sauna Hezemeer"
            - condition: state
              entity_id: person.bart
              state: "Sauna Boetfort"
      sequence:
      - service: notify.bart_phone
        data:
          title: ðŸš™ Moet de auto straks worden voorverwamd?
          message: Geniet van de sauna :)
          data:
            tag: auto_verwarmen      
            color: green
            actions:
            - action: URI
              title: zo ja, klik hier
              uri: /eikenbos-dashboard/e-tron-heater          
    # indien aankomst bij winkel, niets vragen en blijven verwarmen
    - conditions:
        - condition: or
          conditions:
            - condition: state
              entity_id: person.bart
              state: "Aldi Bierbeek"
            - condition: state
              entity_id: person.bart
              state: "Action Bierbeek"
            - condition: state
              entity_id: person.bart
              state: "AH Zaventem"
            - condition: state
              entity_id: person.bart
              state: "Lidl Sterrebeek"
      sequence:
      - service: script.auto_start_climatisatie_nu
    # indien aankomst bij plaats met lang verblijf, vragen 
    - conditions:
        - condition: or
          conditions:
            - condition: state
              entity_id: person.bart
              state: "Waarschoot"
            - condition: state
              entity_id: person.bart
              state: "Koen & Katiana"
      sequence:
      - service: notify.bart_phone
        data:
          title: ðŸš™ Auto straks voorverwamen?
          message: Een warme auto is altijd lekkerder.
          data:
            tag: auto_verwarmen      
            color: green
            actions:
            - action: URI
              title: zo ja, klik hier
              uri: /eikenbos-dashboard/e-tron-heater
      - wait_template: ''
        timeout: '01:00:00'
      - service: notify.bart_phone
        data:
          message: ðŸš™ Moet de auto worden voorverwamd?
          data:
            tag: auto_verwarmen      
            color: green
            actions:
            - action: URI
              title: zo ja, klik hier
              uri: /eikenbos-dashboard/e-tron-heater
    # alle andere locaties
    default:
    - service: notify.bart_phone
      data:
        title: ðŸš™ Auto straks voorverwamen?
        message: Een warme auto is altijd lekkerder.
        data:
          tag: auto_verwarmen
          color: green
          actions:
          - action: URI
            title: zo ja, klik hier
            uri: /eikenbos-dashboard/e-tron-heater
    - wait_template: ''
      timeout: '01:00:00'
    - service: notify.bart_phone
      data:
        message: ðŸš™ Moet de auto worden voorverwamd?
        data:
          tag: auto_verwarmen      
          color: green
          actions:
          - action: URI
            title: zo ja, klik hier
            uri: /eikenbos-dashboard/e-tron-heate
  mode: restart          

- alias: ðŸš— Madouce verlaat auto
  id: '24b7df67-875f-48f9-8a96-4960bb91687a'
  description: ''
  trigger:
    - platform: state
      entity_id: binary_sensor.madouce_phone_connected_to_car
      from: 'on'
      to: 'off'
      for: "00:00:05"
  condition:
    - condition: numeric_state
      entity_id: sensor.audi_e_tron_sportback_outdoor_temperature
      below: 15
  action:
  - choose:
    # indien aankomst thuis, niets doen
    - conditions:
      - condition: state
        entity_id: person.madouce
        state: "home"
      sequence:
    # indien aankomst bij sauna, onmiddellijk vragen
    - conditions:
        - condition: or
          conditions:
            - condition: state
              entity_id: person.madouce
              state: "Sauna Elzenhof"
            - condition: state
              entity_id: person.madouce
              state: "Sauna Hezemeer"
            - condition: state
              entity_id: person.madouce
              state: "Sauna Boetfort"
      sequence:
      - service: notify.madouce_phone
        data:
          title: ðŸš™ Moet de auto straks worden voorverwamd?
          message: Geniet van de sauna :)
          data:
            tag: auto_verwarmen      
            color: green
            actions:
            - action: URI
              title: zo ja, klik hier
              uri: /eikenbos-dashboard/e-tron-heater          
    # indien aankomst bij winkel, niets vragen en blijven verwarmen
    - conditions:
        - condition: or
          conditions:
            - condition: state
              entity_id: person.madouce
              state: "Aldi Bierbeek"
            - condition: state
              entity_id: person.madouce
              state: "Action bierbeek"
            - condition: state
              entity_id: person.madouce
              state: "AH Zaventem"
            - condition: state
              entity_id: person.madouce
              state: "Lidl Sterrebeek"
      sequence:
      - service: script.auto_start_climatisatie_nu
    # indien aankomst bij plaats met lang verblijf, vragen 
    - conditions:
        - condition: or
          conditions:
            - condition: state
              entity_id: person.madouce
              state: "waarschoot"
            - condition: state
              entity_id: person.madouce
              state: "Koen & Katiana"
      sequence:
      - service: notify.madouce_phone
        data:
          title: ðŸš™ Auto straks voorverwamen?
          message: Een warme auto is altijd lekkerder.
          data:
            tag: auto_verwarmen      
            color: green
            actions:
            - action: URI
              title: zo ja, klik hier
              uri: /eikenbos-dashboard/e-tron-heater
      - wait_template: ''
        timeout: '01:00:00'
      - service: notify.madouce_phone
        data:
          message: ðŸš™ Moet de auto worden voorverwamd?
          data:
            tag: auto_verwarmen      
            color: green
            actions:
            - action: URI
              title: zo ja, klik hier
              uri: /eikenbos-dashboard/e-tron-heater
    # alle andere locaties
    default:
    - service: notify.madouce_phone
      data:
        title: ðŸš™ Auto straks voorverwamen?
        message: Een warme auto is altijd lekkerder.
        data:
          tag: auto_verwarmen
          color: green
          actions:
          - action: URI
            title: zo ja, klik hier
            uri: /eikenbos-dashboard/e-tron-heater
    - wait_template: ''
      timeout: '01:00:00'
    - service: notify.madouce_phone
      data:
        message: ðŸš™ Moet de auto worden voorverwamd?
        data:
          tag: auto_verwarmen      
          color: green
          actions:
          - action: URI
            title: zo ja, klik hier
            uri: /eikenbos-dashboard/e-tron-heate
  mode: restart
  
- alias: ðŸš— Auto verwarmen bij begin werkdag bij Toyota Diest
  id: '4ed1d4be-1e9b-42b0-90b9-e32d9f584de0'
  description: ''
  trigger:
  - platform: time
    at: '07:00'
  condition:
  - condition: numeric_state
    entity_id: sensor.audi_e_tron_sportback_outdoor_temperature
    below: 15
  - condition: template
    value_template: >
      {% set car_use_day = 'input_select.car_use_day' ~ now().isoweekday() %}
      {%if states(car_use_day) == "Toyota Diest"%} true {% endif %}
  action:
  - service: notify.madouce_phone
    data:
      title: ðŸš™ De auto wordt nu voorverwarmd.
      message:  Geniet van de warme rit naar Diest.
      data:
        tag: auto_verwarmen
        color: green
        actions:
        - action: URI
          title: Voor meer info, klik hier
          uri: /eikenbos-dashboard/e-tron-heater
  - service: script.auto_start_climatisatie_nu
  mode: single 
 
- alias: ðŸš— Auto verwarmen bij begin werkdag bij Toyota Evere
  id: 'caf13c49-2daa-4e8c-b275-a6811621cf50'
  description: ''
  trigger:
  - platform: time
    at: '07:30'
  condition:
  - condition: numeric_state
    entity_id: sensor.audi_e_tron_sportback_outdoor_temperature
    below: 15
  - condition: template
    value_template: >
      {% set car_use_day = 'input_select.car_use_day' ~ now().isoweekday() %}
      {%if states(car_use_day) == "Toyota Evere"%} true {% endif %}
  action:
  - service: notify.madouce_phone
    data:
      title: ðŸš™ De auto wordt nu voorverwarmd.
      message:  Geniet van de warme rit naar Evere.
      data:
        tag: auto_verwarmen
        color: green
        actions:
        - action: URI
          title: Voor meer info, klik hier
          uri: /eikenbos-dashboard/e-tron-heater
  - service: script.auto_start_climatisatie_nu
  mode: single 

- alias: ðŸš— Auto verwarmen na werkdag bij Toyota Evere
  id: '2e05b1aa-1980-4c0d-b3a7-ee1df7fef055'
  description: ''
  trigger:
  - platform: time
    at: '16:20'
  condition:
  - condition: numeric_state
    entity_id: sensor.audi_e_tron_sportback_outdoor_temperature
    below: 15
  - condition: state
    entity_id: person.madouce
    state: "Toyota Evere"
  action:
  - service: notify.madouce_phone
    data:
      title: ðŸš™ De auto wordt nu voorverwarmd.
      message: Een warme auto is altijd lekkerder. Veilige rit dadelijk.
      data:
        tag: auto_verwarmen
        color: green
        actions:
        - action: URI
          title: Voor meer info, klik hier
          uri: /eikenbos-dashboard/e-tron-heater
  - service: script.auto_start_climatisatie_nu          
  mode: single

- alias: ðŸš— Auto verwarmen na werkdag bij Toyota Diest
  id: '7c5f1cfa-b20a-4b5b-be63-8ad01ec4e57f'
  description: ''
  trigger:
  - platform: time
    at: '16:20'
  condition:
  - condition: numeric_state
    entity_id: sensor.audi_e_tron_sportback_outdoor_temperature
    below: 15
  - condition: state
    entity_id: person.madouce
    state: "Toyota Diest"
  action:
  - service: notify.madouce_phone
    data:
      title: ðŸš™ De auto wordt nu voorverwarmd.
      message: Een warme auto is altijd lekkerder. Veilige rit dadelijk.
      data:
        tag: auto_verwarmen
        color: green
        actions:
        - action: URI
          title: Voor meer info, klik hier
          uri: /eikenbos-dashboard/e-tron-heater
  - service: script.auto_start_climatisatie_nu          
  mode: single 


 
#########################
# Status auto verversen
#########################   

- alias: Bart 3 km van thuis = verversen status auto
  id: '37cfe751-fb7d-4f9b-9a1e-772eeba15f64'
  trigger:
  - platform: numeric_state
    entity_id:
      - proximity.bart_home
    below: 3
  condition:
  - condition: template
    value_template: '{{ trigger.to_state.attributes.dir_of_travel  == "towards" }}'
  action:
  - service: audiconnect.refresh_data
    data:
      vin: WAUZZZGE6MB019131
  mode: single
  
- alias: Madouce 3 km van thuis = verversen status auto
  id: '533ee396-e37b-450b-a5e6-c981a9696b31'
  trigger:
  - platform: numeric_state
    entity_id:
      - proximity.madouce_home
    below: 3
  condition:
  - condition: template
    value_template: '{{ trigger.to_state.attributes.dir_of_travel  == "towards" }}'
  action:
  - service: audiconnect.refresh_data
    data:
      vin: WAUZZZGE6MB019131
  mode: single  
  
- alias: Car sim km veranderd
  id: '0813a89b-64b9-4fa8-934e-7e4ee91ee033'
  description: ''
  trigger:
  - platform: state
    entity_id: input_number.car_sim_km
  condition: []
  action:
  - service: input_number.set_value
    target:
      entity_id: input_number.car_sim_batteryprocent
    data:
      value: '{{ ((states(''input_number.car_sim_km'') | float * 10 ) / (states(''sensor.car_range_per_10percent'')
        | float)) | round(1) }}'
  mode: single


######################################
# gewoon laden (niet thuis)
######################################

- alias: ðŸš— autolader is verbonden (niet thuis) = melding
  id: 'cdd4783a-a810-4b0a-b46d-1b1bf58eb80e'
  description: ''
  trigger:
  - platform: state
    entity_id: sensor.audi_e_tron_sportback_plug_state
    to: 'connected'
  condition:
  - condition: template
    value_template: "{{ states('device_tracker.audi_e_tron_sportback_position') != 'home' }}"
  action:
  - service: notify.bart_phone
    data:
      title: "ðŸš™ Autolader is verbonden." 
      message: "Nu {{states('sensor.audi_e_tron_sportback_state_of_charge')}}%. Nog {{states('sensor.audi_e_tron_sportback_remaining_charge_time')}} laden."
      data:
        color: green
        tag: auto_laden
        timeout: 300
        actions:
        - action: URI
          title: meer info
          uri: /eikenbos-dashboard/e-tron        
  - service: notify.madouce_phone
    data:
      message: "ðŸš™ Autolader is verbonden. Nu {{states('sensor.audi_e_tron_sportback_state_of_charge')}}%."
      data:
        color: green
        tag: auto_laden
        timeout: 300
        actions:
        - action: URI
          title: meer info
          uri: /eikenbos-dashboard/e-tron        
  mode: single

- alias: ðŸš— auto laadt (niet thuis) = melding
  id: '10f06a54-7eea-4d86-9bf8-2ef07549a4d6'
  description: ''
  trigger:
  - platform: state
    entity_id: sensor.audi_e_tron_sportback_charging_state
    from: 'off'
    to: 'charging'
  condition:
  - condition: template
    value_template: "{{ states('device_tracker.audi_e_tron_sportback_position') != 'home' }}"
  action:
  - service: notify.bart_phone
    data:
      title: ðŸš™ Auto is aan het laden.
      message: Nu {{states('sensor.audi_e_tron_sportback_state_of_charge')}}% = {{states('sensor.audi_e_tron_sportback_primary_engine_range')}} km.
        Nog {{states('sensor.audi_e_tron_sportback_remaining_charge_time')}} laden.
      data:
        color: green
        tag: auto_laden
        timeout: 300
        actions:
        - action: URI
          title: meer info
          uri: /eikenbos-dashboard/e-tron
  - service: notify.madouce_phone
    data:
      message: Nu {{states('sensor.audi_e_tron_sportback_state_of_charge')}}% = {{states('sensor.audi_e_tron_sportback_primary_engine_range')}} km.
        Nog {{states('sensor.audi_e_tron_sportback_remaining_charge_time')}} laden.
      data:
        color: green
        tag: auto_laden
        timeout: 300
        actions:
        - action: URI
          title: meer info
          uri: /eikenbos-dashboard/e-tron
  mode: single

- alias: ðŸš— auto gedaan met laden (niet thuis) = melding
  id: '23ebfe4a-e944-49dc-aa3f-e8a1983e8a56'
  description: ''
  trigger:
  - platform: state
    entity_id: sensor.audi_e_tron_sportback_charging_state
    to: 'completed'
  condition: []
  action:
  - service: notify.bart_phone
    data:
      message: "ðŸš™ Auto heeft gedaan met laden. Nu {{states('sensor.audi_e_tron_sportback_state_of_charge')}}%. {{states('sensor.audi_e_tron_sportback_primary_engine_range')}} km."
      data:
        color: green
        tag: auto_laden
        timeout: 43200
        actions:
        - action: URI
          title: meer info
          uri: /eikenbos-dashboard/e-tron
  - service: notify.madouce_phone
    data:
      message: "ðŸš™ Auto heeft gedaan met laden. Nu {{states('sensor.audi_e_tron_sportback_state_of_charge')}}%. {{states('sensor.audi_e_tron_sportback_primary_engine_range')}} km."
      data:
        color: green
        tag: auto_laden
        timeout: 43200
        actions:
        - action: URI
          title: meer info
          uri: /eikenbos-dashboard/e-tron
  mode: single


#######################################
# Check lading 's avonds
######################################
  
- alias: ðŸš— morgen naar Toyota Evere = check 21u30 voldoende geladen?
  id: 'e03b771a-c1d0-49ed-a0d7-8e833e3c228e'
  description: ''
  trigger:
  - platform: time
    at: '21:30:00'  
  condition:
  - condition: template
    value_template: >
      {% set car_use_day = 'input_select.car_use_day' ~ (now().isoweekday() +1) %}
      {%if states(car_use_day) == "Toyota Evere"%} true {% endif %}
  action:
  - service: notify.madouce_phone
    data:
      title: Morgen naar Toyota Evere
      message: "Nu {{states('sensor.audi_e_tron_sportback_state_of_charge')}}%. {% if states('sensor.audi_e_tron_sportback_state_of_charge') |round() > 24 %}Voldoende batterijniveau.{% else %} Onvoldoende geladen. Best 20% Ã  25%.{% endif %}"
  - service: notify.bart_phone
    data:
      title: Morgen naar Toyota Evere
      message: "Nu {{states('sensor.audi_e_tron_sportback_state_of_charge')}}%. {% if states('sensor.audi_e_tron_sportback_state_of_charge') |round() > 24 %}Voldoende batterijniveau.{% else %} Onvoldoende geladen. Best 20% Ã  25%.{% endif %}"
  mode: single
  
- alias: ðŸš— morgen naar Toyota Diest = check 21u30 voldoende geladen?
  id: 'dfb0156e-1033-4259-82d0-08c5bc687860'
  description: ''
  trigger:
  - platform: time
    at: '21:30:00'  
  condition:
  - condition: template
    value_template: >
      {% set car_use_day = 'input_select.car_use_day' ~ (now().isoweekday() +1) %}
      {%if states(car_use_day) == "Toyota Diest"%} true {% endif %}
  action:
  - service: notify.madouce_phone
    data:
      title: Morgen naar Toyota Diest
      message: "Nu {{states('sensor.audi_e_tron_sportback_state_of_charge')}}%. {% if states('sensor.audi_e_tron_sportback_state_of_charge') |round() > 38 %}Voldoende batterijniveau.{% else %} Onvoldoende geladen. Best +/- 40%.{% endif %}"
  - service: notify.bart_phone
    data:
      title: Morgen naar Toyota Diest
      message: "Nu {{states('sensor.audi_e_tron_sportback_state_of_charge')}}%. {% if states('sensor.audi_e_tron_sportback_state_of_charge') |round() > 38 %}Voldoende batterijniveau.{% else %} Onvoldoende geladen. Best +/- 40%.{% endif %}"
  mode: single

- alias: ðŸš— batterij <60% en niet verbonden (week)
  id: '19c7cda6-2abb-4e28-9025-0ea5c4e1caa1'
  description: ''
  trigger:
  - platform: time
    at: '21:30'
  condition:
  - condition: time
    weekday:
    - mon
    - tue
    - wed
    - thu
    - sun
  - condition: template
    value_template: "{% if states('sensor.audi_e_tron_sportback_state_of_charge') | float < 60.0 %} true {% endif %}"
  - condition: state
    entity_id: device_tracker.audi_e_tron_sportback_position
    state: home
  - condition: state
    entity_id: sensor.audi_e_tron_sportback_plug_state
    state: disconnected
  action:
  - service: notify.bart_phone
    data:
      title: Auto laden?
      message: "ðŸš™ Auto maar {{states('sensor.audi_e_tron_sportback_state_of_charge')}}% = {{states('sensor.audi_e_tron_sportback_primary_engine_range')}} km."
      data:
        color: green
        tag: auto_laden
        actions:
        - action: URI
          title: meer info
          uri: /eikenbos-dashboard/car-charging      
  - service: notify.madouce_phone
    data:
      title: Auto laden?
      message: "ðŸš™ Auto maar {{states('sensor.audi_e_tron_sportback_state_of_charge')}}% = {{states('sensor.audi_e_tron_sportback_primary_engine_range')}} km."
      data:
        color: green
        tag: auto_laden
        actions:
        - action: URI
          title: meer info
          uri: /eikenbos-dashboard/car-charging
  mode: single

- alias: ðŸš— batterij <80% en niet verbonden (weekend)
  id: '30ea35b4-3f2a-4702-9df4-323965d8bf70'
  description: ''
  trigger:
  - platform: time
    at: '21:45'
  condition:
  - condition: time
    weekday:
    - fri
    - sat
  - condition: template
    value_template: "{% if states('sensor.audi_e_tron_sportback_state_of_charge') | float < 80.0 %} true {% endif %}"
  - condition: state
    entity_id: device_tracker.audi_e_tron_sportback_position
    state: home
  - condition: state
    entity_id: sensor.audi_e_tron_sportback_plug_state
    state: disconnected
  action:
  - service: notify.bart_phone
    data:
      title: Auto laden voor het weekend?
      message: "ðŸš™ Auto maar {{states('sensor.audi_e_tron_sportback_state_of_charge')}}% = {{states('sensor.audi_e_tron_sportback_primary_engine_range')}} km."
      data:
        color: green
        tag: auto_laden
        actions:
        - action: URI
          title: meer info
          uri: /eikenbos-dashboard/car-charging
  - service: notify.madouce_phone
    data:
      title: Auto laden voor het weekend?
      message: "ðŸš™ Auto maar {{states('sensor.audi_e_tron_sportback_state_of_charge')}}% = {{states('sensor.audi_e_tron_sportback_primary_engine_range')}} km."
      data:
        color: green
        tag: auto_laden
        actions:
        - action: URI
          title: meer info
          uri: /eikenbos-dashboard/car-charging        
  mode: single


#######################################
# Charging modus toggle
######################################

- alias: "ðŸ”‹ smart charging - toggle charging mode"
  id: '49d1aea0-e3b2-4a80-83ba-b2d68d3a3e22'
  trigger:
  - platform: state
    entity_id: input_boolean.smart_charging_mode_timer
  - platform: state
    entity_id: input_boolean.smart_charging_mode_direct
  condition: []
  action:
  - choose:
    - conditions:
      - condition: state
        entity_id: input_boolean.smart_charging_mode_timer
        state: 'on'
      sequence:
      - service: input_boolean.turn_off
        data: {}
        target:
          entity_id: input_boolean.smart_charging_mode_direct
      - service: script.auto_start_laden_timer
        data: {}
    - conditions:
      - condition: state
        entity_id: input_boolean.smart_charging_mode_direct
        state: 'on'
      sequence:
      - service: input_boolean.turn_off
        data: {}
        target:
          entity_id: input_boolean.smart_charging_mode_timer
      - service: script.auto_start_laden_nu
        data: {}       
  mode: restart

  
######################################
# car smart charging (enkel thuis)
######################################

- alias: "ðŸ”‹ smart charging - om 10u, 20u en 22u check of laadkabel ingeplugd is voor smart charging binnen de volgende 10 uren "
  id: '995d850b-435f-46a6-9e5a-9ab89701ddf4'
  description: ''
  trigger:
  - platform: time
    at: '10:00'
  - platform: time
    at: '20:00'
  - platform: time
    at: '22:00'
  condition:
  - condition: state
    entity_id: device_tracker.audi_e_tron_sportback_position
    state: home    
  - condition: state
    entity_id: sensor.audi_e_tron_sportback_plug_state
    state: 'disconnected'
  # voorwaarde: als start tijd < nu + 10 uren (dus starttijd voor 20u)
  - condition: template
    value_template: "{% if as_timestamp(states('sensor.car_smart_charging_start_time')) | timestamp_custom('%Y-%m-%d %H:%M', false) < ((as_timestamp(now())  + (10 * 60 * 60)) | timestamp_custom('%Y-%m-%d %H:%M')) %}true{% endif %}"
  action:
  - service: notify.bart_phone
    data:
      title: "Plug de laadkabel in."
      message: "De auto zou moeten laden op {{ as_timestamp(states('sensor.car_smart_charging_start_time')) | timestamp_custom('%a %-Hu%M', false) }} maar de kabel steekt niet in. Laaddoel is {{ states('input_number.car_smart_charging_target_percentage') | round() }}%."
      data:
        tag: smart_charging
        color: green
        actions:
        - action: URI
          title: meer info
          uri: /eikenbos-dashboard/car-charging        
  mode: single

- alias: "ðŸ”‹ smart charging - laadkabel zopas ingeplugd = op timer zetten (enkel thuis)"
  # bij het inpluggen begint de lader eerst bijna 2 minuten direct te laden want het duurt een tijdje vooraleer het commando om op timer te laden geactiveerd wordt
  id: '6fc148ce-a035-4699-bffd-dc4eb83e52a5'
  description: ''
  trigger:
    - platform: state
      entity_id: sensor.audi_e_tron_sportback_plug_state
      to: connected
  condition:
    - condition: state
      entity_id: device_tracker.audi_e_tron_sportback_position
      state: home
  action:
  - service: notify.bart_phone
    data:
      title: "Smart charging staat nu klaar."
      message: >
         De laadkabel is zopas ingeplugd.<br>
         Smart charging van {{ as_timestamp(states('sensor.car_smart_charging_start_time')) | timestamp_custom('%a %-Hu%M', false)}} tot {{ state_attr('input_datetime.car_smart_charging_target_time', 'timestamp') | timestamp_custom("%a %-Hu%M") }}.<br>
         Er wordt geladen van {{states('sensor.audi_e_tron_sportback_state_of_charge') | round() }}% naar {{states('input_number.car_smart_charging_target_percentage') | round() }}%.
      data:
        tag: smart_charging
        color: green
        actions:
        - action: URI
          title: meer info
          uri: /eikenbos-dashboard/car-charging
  - service: notify.madouce_phone
    data:
      title: "Smart charging staat nu klaar."
      message: >
         De laadkabel is zopas ingeplugd.<br>
         Smart charging van {{ as_timestamp(states('sensor.car_smart_charging_start_time')) | timestamp_custom('%a %-Hu%M', false)}} tot {{ state_attr('input_datetime.car_smart_charging_target_time', 'timestamp') | timestamp_custom("%a %-Hu%M") }}.<br>
         Er wordt geladen van {{states('sensor.audi_e_tron_sportback_state_of_charge') | round() }}% naar {{states('input_number.car_smart_charging_target_percentage') | round() }}%.
      data:
        tag: smart_charging
        color: green
        actions:
        - action: URI
          title: meer info
          uri: /eikenbos-dashboard/car-charging        
  - service: audiconnect.execute_vehicle_action
    data:
      vin: WAUZZZGE6MB019131
      action: start_timed_charger
  mode: single    

- alias: "ðŸ”‹ smart charging - starten op datum en uur van smart charging start time"
  id: '7bcf7836-3149-4eb2-9d40-f0f3f309a249'
  description: ''
  trigger:
  - platform: template
    value_template: "{% if as_timestamp(states('sensor.car_smart_charging_start_time')) | timestamp_custom('%Y-%m-%d %H:%M',false)  == as_timestamp(now()) | timestamp_custom('%Y-%m-%d %H:%M') %}true{% endif %}"
  # Only run routine if smart charging has not yet started (input_boolean.car_smart_charging_busy = off)
  # Because the calculated start time continuously moves while charging, this routine would continously be triggered
  condition:
  - condition: state
    entity_id: input_boolean.smart_charging_mode_timer
    state: 'on'
  - condition: state
    entity_id: input_boolean.car_smart_charging_busy
    state: 'off'
  - condition: state
    entity_id: sensor.audi_e_tron_sportback_charging_state
    state: 'off'
  action:
  - service: input_boolean.turn_on
    data: {}
    target:
      entity_id: input_boolean.car_smart_charging_busy  
  - service: audiconnect.execute_vehicle_action
    data:
      vin: WAUZZZGE6MB019131
      action: start_charger
  - service: notify.bart_phone
    data:
      title: Smart charging gestart.
      message: "Nu: {{states('sensor.audi_e_tron_sportback_state_of_charge') | round()}}%. Laden tot {{states('input_number.car_smart_charging_target_percentage') | round() }}%.<br>Doeluur: {{as_timestamp(states('input_datetime.car_smart_charging_target_time')) | timestamp_custom('%a %-d/%-m %-Hu%M',false) }}"
      data:
        tag: smart_charging
        color: green
        actions:
        - action: URI
          title: meer info
          uri: /eikenbos-dashboard/car-charging
  mode: single

- alias: "ðŸ”‹ smart charging - direct laden gestart"
  id: '242e4f5f-1396-4774-911a-be6e7b685c82'
  trigger:
  - platform: state
    entity_id: input_boolean.smart_charging_mode_direct
    to: 'on'
  condition: []
  action:
  - service: notify.bart_phone
    data:
      title: Direct laden gestart.
      message: >
        {% set target = states('input_number.car_smart_charging_target_percentage') | float(default=0) %}
        {% set soc = states('sensor.audi_e_tron_sportback_state_of_charge') | float(default=0) %}
        {% set nog_te_laden_procent = [target - soc, 0] | max %}
        {% set nog_te_laden_minuten = nog_te_laden_procent * 8.5 | round(2) %}      
        Nu: {{states('sensor.audi_e_tron_sportback_state_of_charge') | round()}}%.
        Laden tot {{states('input_number.car_smart_charging_target_percentage') | round() }}%.<br>
        Laden gedaan op {{ (as_timestamp(now()) + (nog_te_laden_minuten | float(default=0) * 60)) | timestamp_custom('%a %d %b %-Hu%M') }}
      data:
        tag: smart_charging
        color: green
        actions:
        - action: URI
          title: meer info
          uri: /eikenbos-dashboard/car-charging
  mode: single

- alias: "ðŸ”‹ smart charging - laaddoel bereikt (zowel timer als direct)= laden stoppen + melding sturen + timer dag later (enkel thuis)"
  id: 'b7a22897-2c7b-4e07-bf71-380271658908'
  description: ''
  trigger:
  - platform: state
    entity_id: sensor.audi_e_tron_sportback_state_of_charge
  condition:
  - condition: template
    value_template: "{{ states('sensor.audi_e_tron_sportback_state_of_charge')| int(2) >= (states('input_number.car_smart_charging_target_percentage') | int(2)) }}"
  - condition: state
    entity_id: sensor.audi_e_tron_sportback_charging_state
    state: 'charging'
  - condition: state
    entity_id: device_tracker.audi_e_tron_sportback_position
    state: home    
  action:
  - service: input_boolean.turn_off
    data: {}
    target:
      entity_id: input_boolean.car_smart_charging_busy
  - service: notify.bart_phone
    data:
      title: Laaddoel bereikt!
      message: "Laaddoel van {{states('input_number.car_smart_charging_target_percentage') | round() }}% is bereikt. Huidige lading: {{states('sensor.audi_e_tron_sportback_state_of_charge') | round()}}%"
      data:
        tag: smart_charging
        color: green
        actions:
        - action: URI
          title: meer info
          uri: /eikenbos-dashboard/car-charging        
  # targtet time op dag later zetten
  - service: input_datetime.set_datetime
    data:
      datetime: "{{ (as_timestamp(now())  + (24 * 60 * 60) ) | timestamp_custom('%Y-%m-%d %H:%M:%S') }}"
    target:
      entity_id: input_datetime.car_smart_charging_target_time
  - service: audiconnect.execute_vehicle_action
    data:
      vin: WAUZZZGE6MB019131
      action: start_timed_charger
  mode: single
  
- alias: "ðŸ”‹ smart charging - red hours: week 6u-8u -> lader op timer (enkel thuis)"
  id: '0a0bce79-42d8-4184-9dab-9ed54f30f3bf'  
  description: ''
  trigger:
  - platform: time
    at: 06:00
  condition:
  - condition: time
    weekday:
    - mon
    - tue
    - wed
    - thu
    - fri
  - condition: state
    entity_id: device_tracker.audi_e_tron_sportback_position
    state: home    
  action:
  - service: audiconnect.execute_vehicle_action
    data:
      vin: WAUZZZGE6MB019131
      action: start_timed_charger
  - delay: 02:00:00
  - condition: state
    entity_id: input_boolean.car_smart_charging_busy
    state: 'on'  
  - service: audiconnect.execute_vehicle_action
    data:
      vin: WAUZZZGE6MB019131
      action: start_charger
  mode: single
  
- alias: "ðŸ”‹ smart charging - red hours: zaterdag 7u-9u -> lader op timer (enkel thuis)"
  id: '31e6ff24-3423-4332-b4f9-da785af82b26'
  description: ''
  trigger:
  - platform: time
    at: 07:00
  condition:
  - condition: time
    weekday:
    - sat
  - condition: state
    entity_id: device_tracker.audi_e_tron_sportback_position
    state: home    
  action:
  - service: audiconnect.execute_vehicle_action
    data:
      vin: WAUZZZGE6MB019131
      action: start_timed_charger
  - delay: 02:00:00
  - condition: state
    entity_id: input_boolean.car_smart_charging_busy
    state: 'on'
  - service: audiconnect.execute_vehicle_action
    data:
      vin: WAUZZZGE6MB019131
      action: start_charger
  mode: single

- alias: "ðŸ”‹ smart charging - red hours: zondag 8u-12u -> lader op timer (enkel thuis)"
  id: '81cb1458-debb-4378-9313-d34f4029f693'
  description: ''
  trigger:
  - platform: time
    at: 08:00
  condition:
  - condition: time
    weekday:
    - sun
  - condition: state
    entity_id: device_tracker.audi_e_tron_sportback_position
    state: home    
  action:
  - service: audiconnect.execute_vehicle_action
    data:
      vin: WAUZZZGE6MB019131
      action: start_timed_charger
  - delay: 04:00:00
  - service: audiconnect.execute_vehicle_action
    data:
      vin: WAUZZZGE6MB019131
      action: start_charger
  mode: single

- alias: "ðŸ”‹ smart charging - laaddoeluur bereikt = verzetten naar 's anderendaags"
  id: '94c89ef0-a331-4a74-a2bc-d03289b73354'
  description: ''
  trigger:
  - platform: template
    value_template: "{% if as_timestamp(states('input_datetime.car_smart_charging_target_time')) | timestamp_custom('%Y-%m-%d %H:%M',false) == as_timestamp(now()) | timestamp_custom('%Y-%m-%d %H:%M') %}true{% endif %}"
  condition: []
  action:
  - service: input_datetime.set_datetime
    data:
      datetime: "{{ (as_timestamp(now())  + (24 * 60 * 60) ) | timestamp_custom('%Y-%m-%d %H:%M:%S') }}"
    target:
      entity_id: input_datetime.car_smart_charging_target_time
  mode: single
  

#######################################
# Reistijd
######################################

- alias: Meld reistijd naar Toyota Evere (bij ochtendwekker + 7u15 en 7u45)
  id: '0195b18e-5fd6-48a8-ae22-ca0e692fde6c'
  description: ''
  trigger:
  - platform: time
    at: sensor.sm_g986b_next_alarm  
  - platform: time
    at: '07:15'
  - platform: time
    at: '07:45'
  condition:
  - condition: template
    value_template: >
      {% set car_use_day = 'input_select.car_use_day' ~ now().isoweekday() %}
      {%if states(car_use_day) == "Toyota Evere"%} true {% endif %}
  action:
  - service: notify.madouce_phone
    data:
      title: Goede morgen, schat!
      message: "Reistijd naar Toyota Evere is {{states('sensor.waze_travel_time_huis_toyota_evere')}} minuten."
      data:
        tag: auto_laden
  mode: single
  
- alias: Meld reistijd naar Toyota Diest (bij ochtendwekker + 7u15 en 7u45)
  id: '5d976c12-4cdf-4534-821f-332dc180e65d'
  description: ''
  trigger:
  - platform: time
    at: sensor.sm_g986b_next_alarm  
  - platform: time
    at: '07:15'
  - platform: time
    at: '07:45'
  condition:
  - condition: template
    value_template: >
      {% set car_use_day = 'input_select.car_use_day' ~ now().isoweekday() %}
      {%if states(car_use_day) == "Toyota Diest"%} true {% endif %}
  action:
  - service: notify.madouce_phone
    data:
      title: Goede morgen, schat!
      message: "Reistijd naar Toyota Diest is {{states('sensor.waze_travel_time_huis_toyota_diest')}} minuten."
      data:
        tag: auto_laden
  mode: single  

