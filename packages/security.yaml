############################ Table of Contents ############################ 
# 
#   Automations
#     Bart, Madouce en/of Alunya komt thuis (zone) = alarm uit
#     niemand thuis (enkel melding)
#     iemand thuis (enkel melding)
#     niemand thuis = alarm aanzetten
#     Iemand komt thuis (wifi) = alarm uitzetten
#     alarm ingeschakeld aan voordeur
#     alarm uitgeschakeld aan voordeur
#     alarm bij beweging
#     garagepoort staat lang open
#     beweging op oprit

############################ Automations ################################## 

automation:

- alias: ðŸš¨ Bart, Madouce en/of Alunya komt thuis (zone) = alarm uit
  id: '8bc11499-60b0-4b90-9c5b-e36dcd5d03fc'
  description: ''
  trigger:
  - platform: state
    entity_id: person.bart
    to: 'home'
  - platform: state
    entity_id: person.madouce
    to: 'home'
  - platform: state
    entity_id: person.alunya
    to: 'home'
  condition:
  - condition: state
    entity_id: alarm_control_panel.home_alarm
    state: armed_away
  action:
  - device_id: !secret id_tel_bart
    domain: mobile_app
    type: notify
    title: ''
    message: 'âœ…  Alarm is automatisch uitgeschakeld door thuiskomst.'
  - service: alarm_control_panel.alarm_disarm
    target:
      entity_id: alarm_control_panel.home_alarm
    data:
      code: !secret alarm_code
  mode: single

- alias: ðŸš¨ niemand thuis (wifi) = alarm automatisch aanzetten
  id: '71de9fe1-32d9-4a62-ae3a-635d6103daac'
  description: ''
  trigger:
  - platform: state
    entity_id: group.gezin
    to: 'not_home'
    for: 00:05:00
  condition: []
  action:
  - service: alarm_control_panel.alarm_arm_away
    data:
      code: !secret alarm_code
    target:
      entity_id: alarm_control_panel.home_alarm
  - device_id: !secret id_tel_bart
    domain: mobile_app
    type: notify
    title: ''
    message: â›” Alarm is automatisch ingeschakeld wegens niemand thuis.
  mode: single

- alias: ðŸš¨ Iemand komt thuis (wifi) = alarm automatisch uitzetten
  id: 'f17014e2-4cf5-43f0-90ae-be7d609f2a28'
  description: ''
  trigger:
  - platform: state
    entity_id: group.gezin
    to: 'home'
  condition:
  - condition: state
    entity_id: alarm_control_panel.home_alarm
    state: armed_away
  action:
  - service: alarm_control_panel.alarm_disarm
    target:
      entity_id: alarm_control_panel.home_alarm
  - device_id: !secret id_tel_bart
    domain: mobile_app
    type: notify
    title: ''
    message: 'âœ…  Alarm is automatisch uitgeschakeld door thuiskomst.'
  mode: single

- alias: ðŸš¨ alarm ingeschakeld aan voordeur
  id: '1acceb9a-ca45-49b3-ab22-166314aa9cf0'
  description: OK
  trigger:
  - platform: tag
    tag_id: !secret tag_voordeur_arm_alarm
  condition: []
  action:
  - service: notify.bart_phone
    data:
      message: â›” Alarm ingeschakeld aan voordeur.
      title: ''
      data:
        color: blue
        actions:
        - action: URI
          title: Meer info
          uri: /lovelace/humidity
  - service: alarm_control_panel.alarm_arm_away
    target:
      entity_id: alarm_control_panel.home_alarm
    data:
      code: !secret alarm_code
  - service: media_player.volume_set
    data:
      entity_id: media_player.living_speaker
      volume_level: 0.7
  - service: tts.google_say
    data:
      entity_id: media_player.living_speaker
      message: "Alarm ingeschakeld!
      {% if is_state('group.alle_raam_sensoren', 'off') %} Alle ramen zijn dicht!
      {% else %} De volgende ramen staan nog open: {{ expand(states.binary_sensor.kamer_amilya_raam, states.binary_sensor.kamer_alunya_raam, states.binary_sensor.kamer_alunya_schuifraam, states.binary_sensor.badkamer_raam, states.binary_sensor.berging_raam, states.binary_sensor.keuken_raam, states.binary_sensor.living_oprit_raam, states.binary_sensor.living_tuin_raam, states.binary_sensor.master_bedroom_raam, states.binary_sensor.veranda_schuifraam) | selectattr('state','eq','on') | map(attribute='name')| list }}
      {% endif %}"
  - wait_template: ''
    timeout: 00:00:02
  - service: media_player.volume_set
    data:
      entity_id: media_player.living_speaker
      volume_level: 0.4
  mode: queued

- alias: ðŸš¨ alarm uitgeschakeld aan voordeur
  id: 'dc004044-06a8-4ad2-acb8-cafe5f617d1f'
  description: OK
  trigger:
  - platform: tag
    tag_id: !secret tag_voordeur_disarm_alarm
  condition: []
  action:
  - device_id: !secret id_tel_bart
    domain: mobile_app
    type: notify
    title: ''
    message: âœ… Alarm uitgeschakeld aan voordeur.
  - service: alarm_control_panel.alarm_disarm
    data:
      code: !secret alarm_code
    target:
      entity_id: alarm_control_panel.home_alarm
  - service: media_player.volume_set
    data:
      entity_id: media_player.living_speaker
      volume_level: 0.8
  - service: tts.google_say
    data:
      entity_id: media_player.living_speaker
      message: Alarm uitgeschakeld!
  - delay: 00:00:10
  - service: media_player.volume_set
    data:
      entity_id: media_player.living_speaker
      volume_level: 0.4
  mode: single
  
- alias: ðŸš¨ alarm bij beweging
  id: 'f4cc29aa-ef63-411b-a755-343f97a9b721'
  description: ''
  trigger:
  - platform: state
    entity_id:
    # bewegingssensoren
    - binary_sensor.berging_sensor_motion
    - binary_sensor.garage_sensor_motion
    - binary_sensor.keldertrap_sensor_motion
    - binary_sensor.trap_boven_sensor_motion
    - binary_sensor.toilet_motion_sensor_motion
    # raam sensoren
    - binary_sensor.kamer_alunya_raam
    - binary_sensor.kamer_alunya_schuifraam
    - binary_sensor.kamer_amilya_raam
    - binary_sensor.badkamer_raam_kantel
    - binary_sensor.badkamer_raam_wijd
    - binary_sensor.berging_raam
    - binary_sensor.keuken_raam
    - binary_sensor.living_oprit_raam
    - binary_sensor.living_tuin_raam
    - binary_sensor.master_bedroom_raam_kantel
    - binary_sensor.master_bedroom_raam_wijd
    - binary_sensor.veranda_schuifraam
    - binary_sensor.voordeur
    from: 'off'
    to: 'on'
  condition:
  - condition: state
    entity_id: alarm_control_panel.home_alarm
    state: armed_away
  action:
  - service: input_text.set_value
    data:
      entity_id: input_text.alarm_trigger_source
      value: '{{ trigger.to_state.attributes.friendly_name }}'
  - service: alarm_control_panel.alarm_trigger
    entity_id: alarm_control_panel.home_alarm
  mode: single

- alias: ðŸš¨ melding bij alarm trigger
  id: '5fef4d2e-d1e1-4247-9c1f-0cb97130c86e'
  description: NOK
  trigger:
  - platform: state
    entity_id: alarm_control_panel.home_alarm
    to: 'triggered'
  condition: []
  action:
  - service: notify.bart_phone
    data:
      message: TTS
      tts_text: Alarm in Eikenboslaan!
      data:
        color: red
        actions:
        - action: URI
          title: Meer info
          uri: /lovelace/alarm
        vibrationPattern: 10, 10, 10, 10, 10, 10, 10
        channel: alarm
  - service: notify.bart_phone
    data:
      title: 'ðŸš¨ Alarm!'
      message: 'Alarm in Eikenbos: beweging aan {{ states(''input_text.alarm_trigger_source'')}}'
      data:
        color: red
        channel: alarm
  - service: notify.madouce_phone
    data:
      title: 'ðŸš¨ Alarm!'
      message: 'Alarm in Eikenbos: beweging aan {{ states(''input_text.alarm_trigger_source'')}}'
      data:
        color: red
        channel: alarm
  #  - service: media_player.volume_set
  #    data:
  #      entity_id: media_player.nestaudio3875
  #      volume_level: 0.8
  #  - service: media_player.play_media
  #    data:
  #      entity_id: media_player.living_speaker
  #      media_content_id: http://192.168.86.101:8123/local/siren.mp3
  #      media_content_type: music
  #  - service: media_player.play_media
  #    data:
  #      entity_id: media_player.nestaudio3875
  #      media_content_id: http://192.168.86.101:8123/local/siren.mp3
  #      media_content_type: music
  #  - service: media_player.volume_set
  #    data:
  #      entity_id: media_player.nestaudio3875
  #      volume_level: 0.8
  mode: queued

- alias: set_alarm_arm_away
  id: 'b2531e01-aa6d-4a32-b6d7-8627e1450c7e'
  trigger:
  - platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: set_alarm_arm_away
  action:
  - service: alarm_control_panel.alarm_arm_away
    data:
      code: !secret alarm_code
    target:
      entity_id: alarm_control_panel.home_alarm
  mode: single
  
- alias: ðŸ‘€ beweging op oprit
  id: 'c9b40a57-f31d-424f-80fb-c2a8c25c4d21'
  description: Beweging op oprit = melding op living speaker
  trigger:
  - platform: state
    entity_id: binary_sensor.buitensensor_vooraan_motion
    from: 'off'
    to: 'on'
  condition: []
  action:
  - parallel:
    - service: script.google_home_resume
      data:
        action:
          - service: tts.google_say
            data:
              entity_id: media_player.living_speaker
              message: Beweging op oprit!
    - service: script.google_home_resume
      data:
        action:
          - service: tts.google_say
            data:
              entity_id: media_player.veranda_speaker
              message: Beweging op oprit!
  - wait_template: ''
    timeout: 00:00:45
  # - wait_template: ''
  #  timeout: 00:00:07
  #- service: camera.play_stream
  #  data:
  #    media_player: media_player.living_speaker
  #  target:
  #    entity_id: camera.netatmo_eikenbos_oprit
  #- wait_template: ''
  #  timeout: 00:01:30
  #- service: media_player.turn_off
  #  entity_id: media_player.living_speaker
  mode: single
  max_exceeded: silent

- alias: ðŸ‘€ beweging in tuin en alarm ingeschakeld = melding smartphone
  id: '28641c60-8f5e-4856-96a9-e69ceb8c9cc8'
  description: ''
  trigger:
  - platform: state
    entity_id: binary_sensor.tuin_detector_motion
    from: 'off'
    to: 'on'
  condition:
  - condition: state
    entity_id: alarm_control_panel.home_alarm
    state: armed_away
  - condition: state
    entity_id: alarm_control_panel.home_alarm
    state: armed_home  
  action:
  - service: notify.bart_phone
    data:
      title: Beweging in tuin! 
      message: "Beweging begon om {{ as_timestamp(now()) | timestamp_custom('%H:%M:%S') }}."
      data:
        color: red
        tag: beweging_in_tuin
  - service: input_datetime.set_datetime
    target:
      entity_id: input_datetime.tuin_motion_first_trigger
    data:
      timestamp: "{{ now().timestamp() }}"
  - repeat:
      while:
      - condition: state
        entity_id: binary_sensor.tuin_detector_motion
        state: 'on'
      sequence:
      - delay:
          seconds: 15
      - service: notify.bart_phone      
        data:
          title: Beweging in tuin!
          message: "Beweging begon om {{ as_timestamp(now()) | timestamp_custom('%H:%M:%S') }} en duurt al {{((as_timestamp(now()) - state_attr('input_datetime.tuin_motion_first_trigger', 'timestamp')) / 60 )| round(1)  }} min."
          data:
            color: red
            tag: beweging_in_tuin
            alert_once: true
            actions:
            - action: tuin_detector_pause_1u
              title: pauzeer detector 1u
            - action: tuin_detector_pause_2u
              title: pauzeer detector 2u
  - service: notify.bart_phone      
    data:
      title: "Geen beweging in tuin meer."
      message: "Beweging begon om {{ state_attr('input_datetime.tuin_motion_first_trigger', 'timestamp') | timestamp_custom('%H:%M:%S') }} en duurde {{((as_timestamp(now()) - state_attr('input_datetime.tuin_motion_first_trigger', 'timestamp')) / 60 )| round(1) }} min."
      data:
        color: red
        tag: beweging_in_tuin
        actions:
        - action: tuin_detector_pause_1u
          title: pauzeer detector 1u
        - action: tuin_detector_pause_2u
          title: pauzeer detector 2u
  mode: single
  max_exceeded: silent

- alias: ðŸ‘€ beweging op terras en alarm ingeschakeld = melding smartphone
  id: '554afe6c-1cde-4bbd-93e2-dc4851424fc6'
  description: ''
  trigger:
  - platform: state
    entity_id: binary_sensor.terras_detector_motion
    from: 'off'
    to: 'on'
  condition:
  - condition: state
    entity_id: alarm_control_panel.home_alarm
    state: armed_away
  - condition: state
    entity_id: alarm_control_panel.home_alarm
    state: armed_home
  action:
  - service: notify.bart_phone
    data:
      title: ðŸš¨ Beweging op terras! 
      message: "Beweging begon om {{ as_timestamp(now()) | timestamp_custom('%H:%M:%S') }}."
      data:
        color: red
        tag: beweging_op_terras
  - service: input_datetime.set_datetime
    target:
      entity_id: input_datetime.terras_motion_first_trigger
    data:
      timestamp: "{{ now().timestamp() }}"        
  - repeat:
      while:
      - condition: state
        entity_id: binary_sensor.terras_detector_motion
        state: 'on'
      sequence:
      - delay:
          seconds: 15
      - service: notify.bart_phone      
        data:
          title: ðŸš¨ Beweging op terras!
          message: "Beweging begon om {{ as_timestamp(now()) | timestamp_custom('%H:%M:%S') }} en duurt al {{((as_timestamp(now()) - state_attr('input_datetime.terras_motion_first_trigger', 'timestamp')) / 60 )| round(1)  }} min."
          data:
            color: red
            tag: beweging_op_terras
            alert_once: true
            actions:
            - action: terras_detector_pause_1u
              title: pauzeer detector 1u
            - action: terras_detector_pause_2u
              title: pauzeer detector 2u
  - service: notify.bart_phone      
    data:
      title: "Geen beweging op terras meer."
      message: "Beweging begon om {{ state_attr('input_datetime.terras_motion_first_trigger', 'timestamp') | timestamp_custom('%H:%M:%S') }} en duurde {{((as_timestamp(now()) - state_attr('input_datetime.terras_motion_first_trigger', 'timestamp')) / 60 )| round(1) }} min."
      data:
        color: red
        tag: beweging_op_terras
        actions:
        - action: terras_detector_pause_1u
          title: pauzeer detector 1u
        - action: terras_detector_pause_2u
          title: pauzeer detector 2u        
  mode: single
  max_exceeded: silent  

- alias: terras_detector_pause_1u
  id: '6f475717-a594-4024-8407-4c15dd75201d'
  description: ''
  trigger:
  - platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: terras_detector_pause_1u
  condition: []    
  action:
  - service: input_boolean.turn_on
    target:
      entity_id: input_boolean.terras_detector_pause
  - service: switch.turn_off
    target:
      entity_id: switch.terras_detector_motion
  - wait_template: ''
    timeout: 01:00:00
  - service: switch.turn_on
    target:
      entity_id: switch.terras_detector_motion
  - service: input_boolean.turn_off
    target:
      entity_id: input_boolean.terras_detector_pause
  mode: single

- alias: terras_detector_pause_2u
  id: '7a3b00ef-69b3-4f22-97ff-7d2b9068fcae'
  description: ''
  trigger:
  - platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: terras_detector_pause_2u
  condition: []
  action:
  - service: input_boolean.turn_on
    target:
      entity_id: input_boolean.terras_detector_pause  
  - service: switch.turn_off
    target:
      entity_id: switch.terras_detector_motion
  - wait_template: ''
    timeout: 02:00:00
  - service: switch.turn_on
    target:
      entity_id: switch.terras_detector_motion    
  - service: input_boolean.turn_off
    target:
      entity_id: input_boolean.terras_detector_pause
  mode: single      

- alias: tuin_detector_pause_1u
  id: '082ea053-c093-45b6-ae7f-c5f5494b474c'
  description: ''
  trigger:
  - platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: tuin_detector_pause_1u
  condition: []
  action:
  - service: input_boolean.turn_on
    target:
      entity_id: input_boolean.tuin_detector_pause
  - service: switch.turn_off
    target:
      entity_id: switch.tuin_detector_motion
  - wait_template: ''
    timeout: 01:00:00
  - service: switch.turn_on
    target:
      entity_id: switch.tuin_detector_motion    
  - service: input_boolean.turn_off
    target:
      entity_id: input_boolean.tuin_detector_pause
  mode: single

- alias: tuin_detector_pause_2u
  id: '1130caee-1ecf-4ef9-922c-51e7aaf2f357'
  description: ''
  trigger:
  - platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: tuin_detector_pause_2u
  condition: []
  action:
  - service: input_boolean.turn_on
    target:
      entity_id: input_boolean.tuin_detector_pause  
  - service: switch.turn_off
    target:
      entity_id: switch.tuin_detector_motion
  - wait_template: ''
    timeout: 02:00:00
  - service: switch.turn_on
    target:
      entity_id: switch.tuin_detector_motion    
  - service: input_boolean.turn_off
    target:
      entity_id: input_boolean.tuin_detector_pause
  mode: single


###########################################
# Garagepport en voordeur
###########################################

- alias: garagepoort staat lang open
  id: '89cce371-bbfd-4154-a909-1ffeab77f9de'
  description: ''
  trigger:
  - platform: state
    entity_id: cover.garagepoort
    from: 'closed'
    to: 'open'
    for: '00:05:00'
  condition: []
  action:
  - repeat:
      while:
      - condition: state
        entity_id: cover.garagepoort
        state: 'open'
      sequence:
      - service: notify.bart_phone      
        data:
          title: "Garage staat al lang open."
          message: "Staat al {{((as_timestamp(now()) - as_timestamp(states.cover.garagepoort.last_changed)) / 60 )| int() }} minuten open."
          data:
            color: red
            tag: garage_staat_open
      - delay:
          minutes: 2
  - service: notify.bart_phone
    data:
      title: "Garage is nu terug dicht."
      # + 5 = automation is triggered when the garage door is already 5 minutes open 
      message: >
        Stond {{ (((as_timestamp(now()) - as_timestamp(state_attr('automation.garagepoort_staat_lang_open', 'last_triggered') )) / 60 ) + 5) | int() }} minuten open.
      data:
        tag: garage_staat_open
  mode: single

- alias: Voordeur staat lang open
  id: 'c1657da2-d8b2-4c18-a2c4-ae5c3c11b85e'
  description: ''
  trigger:
  - platform: state
    entity_id: binary_sensor.voordeur
    from: 'off'
    to: 'on'
    for: '00:03:00'
  condition: []
  action:
  - service: notify.bart_phone
    data:
      title: Voordeur staat al lang open! 
      message: "Staat al {{((as_timestamp(now()) - as_timestamp(states.binary_sensor.voordeur.last_changed)) / 60 )| int() }} minuten open."
      data:
        color: red
        tag: voordeur_staat_open
  - repeat:
      while:
      - condition: state
        entity_id: binary_sensor.voordeur
        state: 'on'
      sequence:
      - delay:
          minutes: 1
      - service: notify.bart_phone      
        data:
          title: Voordeur staat al lang open!
          message: >-
            Staat al {{ ((as_timestamp(now()) - as_timestamp(state_attr('automation.voordeur_staat_lang_open', 'last_triggered') )) / 60 )| int() }} minuten open.
          data:
            color: red
            tag: voordeur_staat_open
            alert_once: true
  - service: notify.bart_phone
    data:
      title: "Voordeur is nu terug dicht."
      # + 3 = automation is triggered when the door is already 3 minutes open
      message: >-
        Stond {{ (((as_timestamp(now()) - as_timestamp(state_attr('automation.voordeur_staat_lang_open', 'last_triggered') )) / 60 ) + 3) | int() }} minuten open.
      data:
        tag: voordeur_staat_open
  mode: single


- alias: Niemand meer thuis = check open ramen
  id: '9c3567c0-ab6a-4ac9-83c9-82280a299e14'
  description: ''
  trigger:
  - platform: state
    entity_id: group.gezin
    to: not_home
  condition:
  - condition: state
    entity_id: group.alle_ramen_wijd_en_schuifdeuren
    state: 'on'
  action:
  - service: notify.bart_phone
    data:
      message: TTS
      data:
        tts_text: "Er staan nog ramen wijd open!"
        color: red
        actions:
        - action: URI
          title: Meer info
          uri: /lovelace/alarm
        vibrationPattern: 10, 10, 10, 10, 10, 10, 10
        media_stream: alarm_stream
  - service: notify.bart_phone
    data:
      title: Niemand thuis en ramen open
      message: Er staan nog ramen wijd open.
      data:
        color: red
  - service: notify.madouce_phone
    data:
      title: Niemand thuis en ramen open
      message: Er staan nog ramen wijd open.
      data:
        color: red
  mode: single         
